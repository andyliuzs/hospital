<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>预约挂号</title>
	
	<link rel="stylesheet" type="text/css" href="/static/css/home.css" />
	<link rel="stylesheet" type="text/css" href="/static/css/calendar.css" />
	
	<script type="text/javascript" src="/static/js/jquery-1.10.2.min.js"></script>
	<script type="text/javascript" src="/static/js/artDialog/artDialog.js??skin=blue"></script>
	<script type="text/javascript" src="/static/js/artDialog/plugins/iframeTools.js"></script>
	<script type="text/javascript" src="/static/js/minform/minform.js"></script>
	<script type="text/javascript" src="/static/js/minform/drcal.js"></script>

	<script type="text/javascript">
		
		var FUTURE_DAYS = new Array();
		<#list futureDays as day>
			FUTURE_DAYS[${day_index}] = "${day}";
		</#list>
		
		var FUTURE_PLANS = new Array();
		<#list futurePlans as plan>
			FUTURE_PLANS[${plan_index}] = ${plan};
		</#list>
	
		$(document).ready(function(){
			
			// 首先关闭弹出框
			//art.dialog.close();
			
			load();
			
			$("#department").change(function(){   
				update();
			});
		});
		
		// 异步更新已排班的日期
		function update() {
			var value = $("#department").children('option:selected').val();
	        $.ajax({ 
	        	url: "/register/getSchedule/" + value, 
	        	dataType: "json", 
	        	success: function(results) { 
	        		$.each(results.json, function(idx,item){ 
	        			index = $.inArray(idx, FUTURE_DAYS);
						if(index != -1) {
							FUTURE_PLANS[index] = item;
						} 
	        		});
	        		$('#drcal2').html('');
	        		load();
	        	}
	        }); 
		}
		
		
		// 加载日历
		function load() {
			var cal = $.drcal();
			var index = -1;
			cal.bind(
				'drcal.weekRender',
				function(_, tr) {
					$('td', tr).each(
						function(_, td) {
							$(td).append('<div><p class="daynum">' + $(td).attr('day') + '</p><p class="plan"></p></div>');
							index = $.inArray($(td).attr('date'), FUTURE_DAYS);
							if(index != -1) {
								$(td).addClass('selected');
								if(FUTURE_PLANS[index] == false) {
									$(td).removeClass('selected');
								}
							} 
						});
				}).changeMonth(new Date());
			
			cal.delegate('td', 'click', function() {
				art.dialog.open('/register/show/?depart=' + $('#department').val() + "&date=" + $(this).attr('date'), {width: 600, height: 400,
		            close: function () {
		            	//update();
		            }
				}, false);
			});
			
			$('#drcal2').append(cal);
		}
	
	</script>
</head>
<body>

	<div class="wrapper">
		<div class="header">
			<p class="logo"></p>
			<p class="favorite"><a href="">点击收藏</a></p>
		</div>
		<div class="nav">
			<ul>
				<li><a href="/index.html">首&nbsp;&nbsp;页</a></li>
				<li><a href="/intro.html">医院简介</a></li>
				<li><a href="/news.html">新闻中心</a></li>
				<li><a href="/department.html">科室介绍</a></li>
				<li><a href="/doctor.html">名医荟萃</a></li>
				<li><a href="/research.html">科研教学</a></li>
				<li><a href="/register.html" class="current">预约挂号</a></li>
			</ul>
		</div>
		<div class="clear"></div>
		<!-- 图片展示 -->
		<div class="gallery"></div>
		<div class="container">
			<div class="content">
				
				科室：
				<select name="department" id="department">
					<option value="-1">请选择科室</option> 
					<#list departments as department>
						<option value="${department.id}" >${department.name}</option> 
					</#list>
				</select>
				<#if departmentMsg??><label style="color:red">${departmentMsg}</label></#if>
			
				<div id="drcal2"></div>
				
			</div>
			
			<div class="sidebar">
				<div class="user-wrapper">
					<h5>用户管理</h5>
					<div class="user-manage">
						${user.name!}，欢迎您登录！ 
						<p><a href="/register.html">[我要预约]</a></p>
						<p><a href="/register/manage.html">[管理预约]</a></p>
						<p><a href="/user.html">[修改信息]</a></p>
						<p><a href="/logout.html">[注销登录]</a></p>
					</div>
				</div>
			</div>
		</div>
		<div class="clear"></div>
		<div class="footer">
			<p>佳木斯中心医院  &#169	 All Rights Reserved</p>
		</div>
	</div>
</body>
</html>