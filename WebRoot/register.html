<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>预约挂号</title>
	
	<link rel="stylesheet" type="text/css" href="${CONTEXT_PATH}/static/css/home.css" />
	<link rel="stylesheet" type="text/css" href="${CONTEXT_PATH}/static/css/calendar.css" />
	
	<script type="text/javascript" src="${CONTEXT_PATH}/static/js/jquery-1.10.2.min.js"></script>
	<script type="text/javascript" src="${CONTEXT_PATH}/static/js/artDialog/artDialog.js??skin=blue"></script>
	<script type="text/javascript" src="${CONTEXT_PATH}/static/js/artDialog/plugins/iframeTools.js"></script>
	<script type="text/javascript" src="${CONTEXT_PATH}/static/js/minform/minform.js"></script>
	<script type="text/javascript" src="${CONTEXT_PATH}/static/js/minform/drcal.js"></script>

	<script type="text/javascript">
		
		var FUTURE_DAYS = new Array();
		<#list futureDays as day>
			FUTURE_DAYS[${day_index}] = "${day}";
		</#list>
		
		var FUTURE_PLANS = new Array();
		<#list futurePlans as plan>
			FUTURE_PLANS[${plan_index}] = ${plan};
		</#list>
	
		$(document).ready(function(){
			
			// 首先关闭弹出框
			//art.dialog.close();
			
			load();
			
			$("#department").change(function(){   
				update();
			});
		});
		
		// 异步更新已排班的日期
		function update() {
			var value = $("#department").children('option:selected').val();
	        $.ajax({ 
	        	url: "${CONTEXT_PATH}/register/getSchedule/" + value, 
	        	dataType: "json", 
	        	success: function(results) { 
	        		$.each(results.json, function(idx,item){ 
	        			index = $.inArray(idx, FUTURE_DAYS);
						if(index != -1) {
							FUTURE_PLANS[index] = item;
						} 
	        		});
	        		$('#drcal2').html('');
	        		load();
	        	}
	        }); 
		}
		
		
		// 加载日历
		function load() {
			var cal = $.drcal();
			var index = -1;
			cal.bind(
				'drcal.weekRender',
				function(_, tr) {
					$('td', tr).each(
						function(_, td) {
							$(td).append('<div><p class="daynum">' + $(td).attr('day') + '</p><p class="plan"></p></div>');
							index = $.inArray($(td).attr('date'), FUTURE_DAYS);
							if(index != -1) {
								$(td).addClass('selected');
								if(FUTURE_PLANS[index] == false) {
									$(td).removeClass('selected');
								}
							} 
						});
				}).changeMonth(new Date());
			
			cal.delegate('td', 'click', function() {
				art.dialog.open('${CONTEXT_PATH}/register/show/?depart=' + $('#department').val() + "&date=" + $(this).attr('date'), {width: 750, height: 400,
		            close: function () {
		            	//update();
		            }
				}, false);
			});
			
			$('#drcal2').append(cal);
		}
	
		// 收藏本站
		function favorite(title, url) {
			try {
		    	window.external.addFavorite(url, title);
		  	} catch (e) {
				try {
			       window.sidebar.addPanel(title, url, "");
			    } catch (e) {
			         alert("抱歉，您所使用的浏览器无法完成此操作。\n\n加入收藏失败，请使用Ctrl+D进行添加");
			    }
			}
		}
		
	</script>
</head>
<body>

	<div class="wrapper">
		<div class="header">
			<p class="logo"></p>
			<p class="favorite">
				<a href="javascript:void()" onclick="favorite('佳木斯中心医院', 'http://localhost:8080/')">点击收藏</a>
			</p>
		</div>
		<div class="nav">
			<ul>
				<li><a href="${CONTEXT_PATH}/index.html">首&nbsp;&nbsp;页</a></li>
				<li><a href="${CONTEXT_PATH}/intro.html">医院简介</a></li>
				<li><a href="${CONTEXT_PATH}/news.html">新闻中心</a></li>
				<li><a href="${CONTEXT_PATH}/department.html">科室介绍</a></li>
				<li><a href="${CONTEXT_PATH}/doctor.html">名医荟萃</a></li>
				<li><a href="${CONTEXT_PATH}/research.html">科研教学</a></li>
				<li><a href="${CONTEXT_PATH}/register.html" class="current">预约挂号</a></li>
			</ul>
		</div>
		<div class="clear"></div>
		<!-- 图片展示 -->
		<div class="gallery"></div>
		<div class="container">
			<div class="content">
				<div style="margin-left:10px;">
					<div style="height:35px;line-height:35px;">
						科室：
						<select name="department" id="department">
							<option value="-1">请选择科室</option> 
							<#list departments as department>
								<option value="${department.id}" >${department.name}</option> 
							</#list>
						</select>
						<#if departmentMsg??><label style="color:red">${departmentMsg}</label></#if>
					</div>
					<div id="drcal2"></div>
				</div>
			</div>
			
			<div class="sidebar">
				<div class="user-wrapper">
					<h5>用户管理</h5>
					<div class="user-manage">
						<label>${user.name!}，欢迎您登录！</label>
						<p><a href="${CONTEXT_PATH}/register.html">[我要预约]</a></p>
						<p><a href="${CONTEXT_PATH}/register/manage.html">[管理预约]</a></p>
						<p><a href="${CONTEXT_PATH}/user.html">[修改信息]</a></p>
						<p><a href="${CONTEXT_PATH}/logout.html">[注销登录]</a></p>
					</div>
				</div>
			</div>
		</div>
		<div class="clear"></div>
		<div class="footer">
			<p>佳木斯中心医院  &#169	 All Rights Reserved</p>
		</div>
	</div>
</body>
</html>